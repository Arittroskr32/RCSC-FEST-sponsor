{% extends "base.html" %}

{% block title %}Speakers - Fest Sponsor Management{% endblock %}

{% block content %}
<div class="management-container">
    <div class="management-header">
        <h1><i class="fas fa-microphone"></i> Speaker Management</h1>
        <p>Search, add, and manage speaker information</p>
        <div class="total-count">
            Total Speakers: <span id="speaker-count">0</span>
        </div>
    </div>
    <div class="management-actions">
        <!-- Search Section -->
        <div class="action-section">
            <h3><i class="fas fa-search"></i> Search Speakers</h3>
            <div class="search-form">
                <input type="text" id="searchInput" placeholder="Search by name, mail, linkedin, designation...">
                <button onclick="searchSpeakers()" class="btn btn-primary">
                    <i class="fas fa-search"></i> Search
                </button>
                <button onclick="clearSearch()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
            <div id="searchResults" class="search-results" style="margin-top: 24px;"></div>
        </div>
        <!-- Add Speaker Section -->
        <div class="action-section">
            <h3><i class="fas fa-plus"></i> Add New Speaker</h3>
            <form id="addSpeakerForm" class="add-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="speakerName">Name *</label>
                        <input type="text" id="speakerName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="speakerPhone">Phone (optional)</label>
                        <input type="tel" id="speakerPhone" name="phone">
                    </div>
                    <div class="form-group">
                        <label for="speakerMail">Mail (optional)</label>
                        <input type="email" id="speakerMail" name="mail">
                    </div>
                    <div class="form-group">
                        <label for="speakerLinkedin">LinkedIn Profile *</label>
                        <input type="url" id="speakerLinkedin" name="linkedin" required>
                    </div>
                    <div class="form-group">
                        <label for="speakerDesignation">Designation *</label>
                        <input type="text" id="speakerDesignation" name="designation" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-plus"></i> Add Speaker
                </button>
            </form>
        </div>
        <!-- List All Speakers Section -->
        <div class="action-section">
            <h3><i class="fas fa-list"></i> All Speakers</h3>
            <div style="display:flex; gap:16px; margin-bottom:16px;">
                <button onclick="loadAllSpeakers()" class="btn btn-info">
                    <i class="fas fa-eye"></i> Show All Speakers
                </button>
                <button onclick="downloadAllSpeakers()" class="btn btn-success">
                    <i class="fas fa-download"></i> Download All Speakers
                </button>
            </div>
            <div id="speakersList" class="results-list" style="margin-top:24px;"></div>
        </div>
    </div>
</div>

<div id="editSpeakerModal" class="modal" style="display:none;">
    <div class="modal-content card-style">
        <span class="close" onclick="closeEditSpeakerModal()">&times;</span>
        <h3 style="text-align:center; margin-bottom:18px;">Edit Speaker</h3>
        <form id="editSpeakerForm" style="padding: 0 12px;">
            <input type="hidden" id="editSpeakerId">
            <div class="card-fields">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editSpeakerName">Name *</label>
                        <input type="text" id="editSpeakerName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="editSpeakerPhone">Phone (optional)</label>
                        <input type="tel" id="editSpeakerPhone" name="phone">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editSpeakerMail">Mail (optional)</label>
                        <input type="email" id="editSpeakerMail" name="mail">
                    </div>
                    <div class="form-group">
                        <label for="editSpeakerLinkedin">LinkedIn Profile *</label>
                        <input type="url" id="editSpeakerLinkedin" name="linkedin" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editSpeakerDesignation">Designation *</label>
                        <input type="text" id="editSpeakerDesignation" name="designation" required>
                    </div>
                </div>
            </div>
            <div style="text-align:center; margin-top:18px;">
                <button type="submit" class="btn btn-success" style="width:60%; font-size:1.1em;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>
<style>
.card-style {
    max-width: 540px;
    margin: 32px auto;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.12);
    padding: 24px 0 18px 0;
    border: 1px solid #e0e0e0;
}
.card-fields .form-row {
    display: flex;
    gap: 18px;
    margin-bottom: 12px;
}
.card-fields .form-group {
    flex: 1;
    display: flex;
    flex-direction: column;
}
.card-fields label {
    font-weight: 500;
    margin-bottom: 6px;
}
.card-fields input, .card-fields select {
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1em;
}
.card-fields input:focus, .card-fields select:focus {
    outline: none;
    border-color: #007bff;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentSpeakers = [];

document.addEventListener('DOMContentLoaded', function() {
    loadSpeakerCount();
    document.getElementById('addSpeakerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addSpeaker();
    });
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchSpeakers();
        }
    });
});

async function loadSpeakerCount() {
    try {
        const response = await fetch('/api/speakers/count');
        const data = await response.json();
        document.getElementById('speaker-count').textContent = data.count || 0;
    } catch (error) {
        console.error('Error loading speaker count:', error);
    }
}

async function searchSpeakers() {
    const searchTerm = document.getElementById('searchInput').value.trim();
    if (!searchTerm) {
        showAlert('Please enter a search term', 'warning');
        return;
    }
    try {
        const response = await fetch('/api/speakers/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ search_term: searchTerm })
        });
        const speakers = await response.json();
        displaySearchResults(speakers);
    } catch (error) {
        console.error('Error searching speakers:', error);
        showAlert('Error searching speakers', 'error');
    }
}

function displaySearchResults(speakers) {
    const resultsDiv = document.getElementById('searchResults');
    if (speakers.length === 0) {
        resultsDiv.innerHTML = '<p class="no-results">No speakers found matching your search.</p>';
        return;
    }
    let html = `<h4 style="margin-bottom:18px;">Search Results:</h4><div class="table-responsive" style="margin-bottom:24px;"><table class="table table-bordered table-striped" style="margin-bottom:0;">
        <thead>
            <tr>
                <th style="padding:12px 18px;">Name</th>
                <th style="padding:12px 18px;">Phone</th>
                <th style="padding:12px 18px;">Mail</th>
                <th style="padding:12px 18px;">LinkedIn</th>
                <th style="padding:12px 18px;">Designation</th>
            </tr>
        </thead>
        <tbody>`;
    speakers.forEach(s => {
        html += `<tr>
            <td style="padding:10px 18px;">${s.name || ''}</td>
            <td style="padding:10px 18px;">${s.phone || ''}</td>
            <td style="padding:10px 18px;">${s.mail || ''}</td>
            <td style="padding:10px 18px;">${s.linkedin ? `<a href="${s.linkedin}" target="_blank">${s.linkedin}</a>` : ''}</td>
            <td style="padding:10px 18px;">${s.designation || ''}</td>
        </tr>`;
    });
    html += '</tbody></table></div>';
    resultsDiv.innerHTML = html;
}

function loadAllSpeakers() {
    fetch('/api/speakers/list')
        .then(response => response.json())
        .then(speakers => {
            displayAllSpeakersTable(speakers);
        });
}

function displayAllSpeakersTable(speakers) {
    const listDiv = document.getElementById('speakersList');
    if (speakers.length === 0) {
        listDiv.innerHTML = '<p class="no-results">No speakers found.</p>';
        return;
    }
    let html = `<h4 style="margin-bottom:18px;">All Speakers:</h4><div class="table-responsive" style="margin-bottom:24px;"><table class="table table-bordered table-striped" style="margin-bottom:0;">
        <thead>
            <tr>
                <th style="padding:12px 18px;">Name</th>
                <th style="padding:12px 18px;">Phone</th>
                <th style="padding:12px 18px;">Mail</th>
                <th style="padding:12px 18px;">LinkedIn</th>
                <th style="padding:12px 18px;">Designation</th>
                <th style="padding:12px 18px;">Actions</th>
            </tr>
        </thead>
        <tbody>`;
    speakers.forEach(s => {
        html += `<tr>
            <td style="padding:10px 18px;">${s.name || ''}</td>
            <td style="padding:10px 18px;">${s.phone || ''}</td>
            <td style="padding:10px 18px;">${s.mail || ''}</td>
            <td style="padding:10px 18px;">${s.linkedin ? `<a href="${s.linkedin}" target="_blank">${s.linkedin}</a>` : ''}</td>
            <td style="padding:10px 18px;">${s.designation || ''}</td>
            <td style="padding:10px 18px;">
                <button class="btn btn-warning btn-sm" onclick="editSpeaker('${s._id}')"><i class="fas fa-edit"></i> Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteSpeaker('${s._id}')"><i class="fas fa-trash"></i> Delete</button>
            </td>
        </tr>`;
    });
    html += '</tbody></table></div>';
    listDiv.innerHTML = html;
}

function editSpeaker(id) {
    fetch(`/api/speakers/list`)
        .then(response => response.json())
        .then(speakers => {
            const s = speakers.find(x => x._id === id);
            if (!s) return;
            document.getElementById('editSpeakerId').value = s._id;
            document.getElementById('editSpeakerName').value = s.name || '';
            document.getElementById('editSpeakerPhone').value = s.phone || '';
            document.getElementById('editSpeakerMail').value = s.mail || '';
            document.getElementById('editSpeakerLinkedin').value = s.linkedin || '';
            document.getElementById('editSpeakerDesignation').value = s.designation || '';
            document.getElementById('editSpeakerModal').style.display = 'block';
        });
}

function closeEditSpeakerModal() {
    document.getElementById('editSpeakerModal').style.display = 'none';
}

document.getElementById('editSpeakerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const id = document.getElementById('editSpeakerId').value;
    const data = {
        name: document.getElementById('editSpeakerName').value,
        phone: document.getElementById('editSpeakerPhone').value,
        mail: document.getElementById('editSpeakerMail').value,
        linkedin: document.getElementById('editSpeakerLinkedin').value,
        designation: document.getElementById('editSpeakerDesignation').value
    };
    try {
        const response = await fetch(`/api/speakers/update/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            showAlert('Speaker updated successfully!', 'success');
            closeEditSpeakerModal();
            loadAllSpeakers();
        } else {
            showAlert(result.message || 'Error updating speaker', 'error');
        }
    } catch (error) {
        showAlert('Error updating speaker', 'error');
    }
});

async function addSpeaker() {
    const form = document.getElementById('addSpeakerForm');
    const formData = new FormData(form);
    const speakerData = {
        name: formData.get('name'),
        phone: formData.get('phone'),
        mail: formData.get('mail'),
        linkedin: formData.get('linkedin'),
        designation: formData.get('designation')
    };
    try {
        const response = await fetch('/api/speakers/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(speakerData)
        });
        const result = await response.json();
        if (result.success) {
            showAlert(result.message || 'Speaker added successfully!', 'success');
            form.reset();
            loadSpeakerCount();
        } else {
            if (result.message && result.message.includes('already exists')) {
                showAlert(result.message, 'warning');
            } else {
                showAlert(result.message || 'Error adding speaker', 'error');
            }
        }
    } catch (error) {
        console.error('Error adding speaker:', error);
        showAlert('Error adding speaker', 'error');
    }
}

async function deleteSpeaker(speakerId) {
    if (!confirm('Are you sure you want to delete this speaker?')) {
        return;
    }
    try {
        const response = await fetch(`/api/speakers/delete/${speakerId}`, {
            method: 'DELETE'
        });
        const result = await response.json();
        if (result.success) {
            showAlert('Speaker deleted successfully!', 'success');
            loadSpeakerCount();
            if (currentSpeakers.length > 0) {
                loadAllSpeakers();
            }
        } else {
            showAlert(result.message || 'Error deleting speaker', 'error');
        }
    } catch (error) {
        console.error('Error deleting speaker:', error);
        showAlert('Error deleting speaker', 'error');
    }
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').innerHTML = '';
}

function showAlert(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `
        ${message}
        <button class="close-alert">&times;</button>
    `;
    const container = document.querySelector('.management-container');
    container.insertBefore(alert, container.firstChild);
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
    alert.querySelector('.close-alert').addEventListener('click', () => {
        alert.remove();
    });
}

function downloadAllSpeakers() {
    window.location.href = '/api/speakers/download';
}
</script>
{% endblock %}
