{% extends "base.html" %}

{% block title %}Sponsors - Fest Sponsor Management{% endblock %}

{% block content %}
<div class="management-container">
    <div class="management-header">
        <h1><i class="fas fa-handshake"></i> Sponsor Management</h1>
        <p>Search, add, and manage your event sponsors</p>
        <div class="total-count">
            Total Sponsors: <span id="sponsor-count">0</span>
        </div>
    </div>
    
    <div class="management-actions">
        <!-- Search Section -->
        <div class="action-section">
            <h3><i class="fas fa-search"></i> Search Sponsors</h3>
            <div class="search-form">
                <input type="text" id="searchInput" placeholder="Search by company name, website, sponsor mail...">
                <button onclick="searchSponsors()" class="btn btn-primary">
                    <i class="fas fa-search"></i> Search
                </button>
                <button onclick="clearSearch()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
            <div id="searchResults" class="search-results" style="margin-top: 24px;"></div>
        </div>
        
        <!-- Add Sponsor Section -->
        <div class="action-section">
            <h3><i class="fas fa-plus"></i> Add New Sponsor</h3>
            <form id="addSponsorForm" class="add-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="companyName">Company Name *</label>
                        <input type="text" id="companyName" name="company_name" required>
                    </div>
                    <div class="form-group">
                        <label for="ctoPhone">CTO Phone (optional)</label>
                        <input type="tel" id="ctoPhone" name="cto_phone">
                    </div>
                    <div class="form-group">
                        <label for="ceoPhone">CEO Phone (optional)</label>
                        <input type="tel" id="ceoPhone" name="ceo_phone">
                    </div>
                    <div class="form-group">
                        <label for="ceoMail">CEO Mail (optional)</label>
                        <input type="email" id="ceoMail" name="ceo_mail">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Previous Sponsor</label><br>
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <label style="margin-bottom:0;"><input type="radio" name="previous_sponsor" value="yes"> Yes</label>
                            <label style="margin-bottom:0;"><input type="radio" name="previous_sponsor" value="no"> No</label>
                            <label style="margin-bottom:0;"><input type="radio" name="previous_sponsor" value="not idea"> Not Idea</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="website">Website *</label>
                        <input type="url" id="website" name="website" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="sponsorMail">Sponsor Mail *</label>
                        <input type="email" id="sponsorMail" name="sponsor_mail" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="ruetianName">Ruetian Name</label>
                        <input type="text" id="ruetianName" name="ruetian_name">
                    </div>
                    <div class="form-group">
                        <label for="ruetianPhone">Ruetian Phone</label>
                        <input type="tel" id="ruetianPhone" name="ruetian_phone">
                    </div>
                    <div class="form-group">
                        <label for="ruetianMail">Ruetian Mail</label>
                        <input type="email" id="ruetianMail" name="ruetian_mail">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="ruetianLinkedin">Ruetian LinkedIn Profile</label>
                        <input type="url" id="ruetianLinkedin" name="ruetian_linkedin">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="category">Category *</label>
                        <select id="category" name="category" required onchange="toggleOtherCategory(this)">
                            <option value="">Select Category</option>
                            <option value="security">Security</option>
                            <option value="group of industry">Group of Industry</option>
                            <option value="international">International</option>
                            <option value="others">Others</option>
                        </select>
                    </div>
                    <div class="form-group" id="otherCategoryGroup" style="display:none;">
                        <label for="otherCategory">Other Category</label>
                        <input type="text" id="otherCategory" name="other_category">
                    </div>
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-plus"></i> Add Sponsor
                </button>
            </form>
        </div>
        
        {% if not moderator_only %}
        <!-- List All Sponsors Section -->
        {% if not moderator_only %}
        <div class="action-section">
            <h3><i class="fas fa-list"></i> All Sponsors</h3>
            <div style="display:flex; gap:16px; margin-bottom:16px;">
                <button onclick="loadAllSponsors()" class="btn btn-info">
                    <i class="fas fa-eye"></i> Show All Sponsors
                </button>
                <button onclick="downloadAllSponsors()" class="btn btn-success">
                    <i class="fas fa-download"></i> Download All Sponsors
                </button>
            </div>
            <div id="sponsorsList" class="results-list" style="margin-top:24px;"></div>
        </div>
        {% endif %}
        {% endif %}
    </div>
</div>

<div id="editSponsorModal" class="modal" style="display:none;">
    <div class="modal-content card-style">
        <h3 style="text-align:center; margin-bottom:18px;">Edit Sponsor</h3>
        <form id="editSponsorForm" style="padding: 0 12px;">
            <input type="hidden" id="editSponsorId">
            <div class="card-fields">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editCompanyName">Company Name *</label>
                        <input type="text" id="editCompanyName" name="company_name" required>
                    </div>
                    <div class="form-group">
                        <label for="editCtoPhone">CTO Phone (optional)</label>
                        <input type="tel" id="editCtoPhone" name="cto_phone">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editCeoPhone">CEO Phone (optional)</label>
                        <input type="tel" id="editCeoPhone" name="ceo_phone">
                    </div>
                    <div class="form-group">
                        <label for="editCeoMail">CEO Mail (optional)</label>
                        <input type="email" id="editCeoMail" name="ceo_mail">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Previous Sponsor</label><br>
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <label style="margin-bottom:0;"><input type="radio" name="edit_previous_sponsor" value="yes"> Yes</label>
                            <label style="margin-bottom:0;"><input type="radio" name="edit_previous_sponsor" value="no"> No</label>
                            <label style="margin-bottom:0;"><input type="radio" name="edit_previous_sponsor" value="not idea"> Not Idea</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editWebsite">Website *</label>
                        <input type="url" id="editWebsite" name="website" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editSponsorMail">Sponsor Mail *</label>
                        <input type="email" id="editSponsorMail" name="sponsor_mail" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editRuetianName">Ruetian Name</label>
                        <input type="text" id="editRuetianName" name="ruetian_name">
                    </div>
                    <div class="form-group">
                        <label for="editRuetianPhone">Ruetian Phone</label>
                        <input type="tel" id="editRuetianPhone" name="ruetian_phone">
                    </div>
                    <div class="form-group">
                        <label for="editRuetianMail">Ruetian Mail</label>
                        <input type="email" id="editRuetianMail" name="ruetian_mail">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editRuetianLinkedin">Ruetian LinkedIn Profile</label>
                        <input type="url" id="editRuetianLinkedin" name="ruetian_linkedin">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editCategory">Category *</label>
                        <select id="editCategory" name="category" required onchange="toggleEditOtherCategory(this)">
                            <option value="">Select Category</option>
                            <option value="security">Security</option>
                            <option value="group of industry">Group of Industry</option>
                            <option value="international">International</option>
                            <option value="others">Others</option>
                        </select>
                    </div>
                    <div class="form-group" id="editOtherCategoryGroup" style="display:none;">
                        <label for="editOtherCategory">Other Category</label>
                        <input type="text" id="editOtherCategory" name="other_category">
                    </div>
                </div>
            </div>
            <div style="text-align:center; margin-top:18px;">
                <div style="display:flex; justify-content:center; gap:18px;">
                    <button type="submit" class="btn btn-success" style="width:50%; font-size:1.1em;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary" style="width:30%; font-size:1.1em;" onclick="closeEditSponsorModal()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
<style>
.card-style {
    max-width: 540px;
    margin: 32px auto;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.12);
    padding: 24px 0 18px 0;
    border: 1px solid #e0e0e0;
}
.card-fields .form-row {
    display: flex;
    gap: 18px;
    margin-bottom: 12px;
}
.card-fields .form-group {
    flex: 1;
    display: flex;
    flex-direction: column;
}
.card-fields label {
    font-weight: 500;
    margin-bottom: 6px;
}
.card-fields input, .card-fields select {
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1em;
}
.card-fields input:focus, .card-fields select:focus {
    outline: none;
    border-color: #007bff;
}
/* Toast styles */
.toast-message {
    transition: opacity 0.3s;
    cursor: pointer;
}
.toast-success {
    background: #28a745;
}
.toast-warning {
    background: #ffc107;
    color: #212529;
}
.toast-error {
    background: #dc3545;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let isAdmin = "{{ 'true' if is_admin else 'false' }}";
let currentSponsors = [];

function toggleOtherCategory(select) {
    const otherGroup = document.getElementById('otherCategoryGroup');
    if (select.value === 'others') {
        otherGroup.style.display = 'block';
    } else {
        otherGroup.style.display = 'none';
        document.getElementById('otherCategory').value = '';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadSponsorCount();
    document.getElementById('addSponsorForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addSponsor();
    });
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchSponsors();
        }
    });
});

async function loadSponsorCount() {
    try {
        const response = await fetch('/api/sponsors/count');
        const data = await response.json();
        document.getElementById('sponsor-count').textContent = data.count || 0;
    } catch (error) {
        console.error('Error loading sponsor count:', error);
    }
}

async function searchSponsors() {
    const searchTerm = document.getElementById('searchInput').value.trim();
    if (!searchTerm) {
        showAlert('Please enter a search term', 'warning');
        return;
    }
    try {
        const response = await fetch('/api/sponsors/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ search_term: searchTerm })
        });
        const sponsors = await response.json();
        displaySearchResults(sponsors);
    } catch (error) {
        console.error('Error searching sponsors:', error);
        showAlert('Error searching sponsors', 'error');
    }
}

function displaySearchResults(sponsors) {
    const resultsDiv = document.getElementById('searchResults');
    if (sponsors.length === 0) {
        resultsDiv.innerHTML = '<p class="no-results">No sponsors found matching your search.</p>';
        return;
    }
    let html = `<h4 style="margin-bottom:18px;">Search Results:</h4><div class="table-responsive" style="margin-bottom:24px;"><table class="table table-bordered table-striped" style="margin-bottom:0;">
        <thead>
            <tr>
                <th style="padding:12px 18px;">Company Name</th>
                <th style="padding:12px 18px;">Previous Sponsor</th>
                <th style="padding:12px 18px;">Website</th>
                <th style="padding:12px 18px;">Sponsor Mail</th>
            </tr>
        </thead>
        <tbody>`;
    sponsors.forEach(sponsor => {
        html += `<tr>
            <td style="padding:10px 18px;">${sponsor.company_name || ''}</td>
            <td style="padding:10px 18px;">${sponsor.previous_sponsor || ''}</td>
            <td style="padding:10px 18px;">${sponsor.website ? `<a href="${sponsor.website}" target="_blank">${sponsor.website}</a>` : ''}</td>
            <td style="padding:10px 18px;">${sponsor.sponsor_mail || ''}</td>
        </tr>`;
    });
    html += '</tbody></table></div>';
    resultsDiv.innerHTML = html;
}

function loadAllSponsors() {
    fetch('/api/sponsors/list')
        .then(response => response.json())
        .then(sponsors => {
            displayAllSponsorsTable(sponsors);
        });
}

// ...existing code...

function displayAllSponsorsTable(sponsors) {
    const listDiv = document.getElementById('sponsorsList');
    if (sponsors.length === 0) {
        listDiv.innerHTML = '<p class="no-results">No sponsors found.</p>';
        return;
    }
    let html = `<h4 style="margin-bottom:18px;">All Sponsors:</h4><div class="table-responsive" style="margin-bottom:24px;"><table class="table table-bordered table-striped" style="margin-bottom:0;">
        <thead>
            <tr>
                <th style="padding:12px 18px;">Company Name</th>
                <th style="padding:12px 18px;">Website</th>
                <th style="padding:12px 18px;">Ruetian Name</th>
                <th style="padding:12px 18px;">Category</th>
                ${isAdmin ? '<th style="padding:12px 18px;">Actions</th>' : ''}
            </tr>
        </thead>
        <tbody>`;
    sponsors.forEach(sponsor => {
        html += `<tr>
            <td style="padding:10px 18px;">${sponsor.company_name || ''}</td>
            <td style="padding:10px 18px;">${sponsor.website ? `<a href="${sponsor.website}" target="_blank">${sponsor.website}</a>` : ''}</td>
            <td style="padding:10px 18px;">${sponsor.ruetian_name || ''}</td>
            <td style="padding:10px 18px;">${sponsor.category || ''}</td>`;
        if (isAdmin) {
            html += `<td style="padding:10px 18px;">
                <button class="btn btn-warning btn-sm" onclick="editSponsor('${sponsor._id}')"><i class="fas fa-edit"></i> Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteSponsor('${sponsor._id}')"><i class="fas fa-trash"></i> Delete</button>
            </td>`;
        }
        html += `</tr>`;
    });
    html += '</tbody></table></div>';
    listDiv.innerHTML = html;
}

function editSponsor(id) {
    if (!isAdmin) return;
    fetch(`/api/sponsors/${id}`)
        .then(response => response.json())
        .then(sponsor => {
            if (!sponsor || sponsor.error) return;
            document.getElementById('editSponsorId').value = sponsor._id;
            document.getElementById('editCompanyName').value = sponsor.company_name || '';
            document.getElementById('editCtoPhone').value = sponsor.cto_phone || '';
            document.getElementById('editCeoPhone').value = sponsor.ceo_phone || '';
            document.getElementById('editCeoMail').value = sponsor.ceo_mail || '';
            document.getElementById('editWebsite').value = sponsor.website || '';
            document.getElementById('editSponsorMail').value = sponsor.sponsor_mail || '';
            document.getElementById('editRuetianName').value = sponsor.ruetian_name || '';
            document.getElementById('editRuetianPhone').value = sponsor.ruetian_phone || '';
            document.getElementById('editRuetianMail').value = sponsor.ruetian_mail || '';
            document.getElementById('editRuetianLinkedin').value = sponsor.ruetian_linkedin || '';
            document.getElementById('editCategory').value = sponsor.category || '';
            document.getElementById('editOtherCategory').value = sponsor.other_category || '';
            // Set previous sponsor radio
            document.querySelectorAll('input[name="edit_previous_sponsor"]').forEach(radio => {
                radio.checked = radio.value === (sponsor.previous_sponsor || '');
            });
            toggleEditOtherCategory(document.getElementById('editCategory'));
            document.getElementById('editSponsorModal').style.display = 'block';
            // Scroll to the modal card
            setTimeout(() => {
                document.getElementById('editSponsorModal').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        });
}

function closeEditSponsorModal() {
    document.getElementById('editSponsorModal').style.display = 'none';
}

document.getElementById('editSponsorForm').addEventListener('submit', async function(e) {
    if (!isAdmin) return;
    e.preventDefault();
    const id = document.getElementById('editSponsorId').value;
    const data = {
        company_name: document.getElementById('editCompanyName').value,
        cto_phone: document.getElementById('editCtoPhone').value,
        ceo_phone: document.getElementById('editCeoPhone').value,
        ceo_mail: document.getElementById('editCeoMail').value,
        previous_sponsor: document.querySelector('input[name="edit_previous_sponsor"]:checked')?.value,
        website: document.getElementById('editWebsite').value,
        sponsor_mail: document.getElementById('editSponsorMail').value,
        ruetian_name: document.getElementById('editRuetianName').value,
        ruetian_phone: document.getElementById('editRuetianPhone').value,
        ruetian_mail: document.getElementById('editRuetianMail').value,
        ruetian_linkedin: document.getElementById('editRuetianLinkedin').value,
        category: document.getElementById('editCategory').value,
        other_category: document.getElementById('editOtherCategory').value
    };
    try {
        const response = await fetch(`/api/sponsors/update/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            showAlert('Sponsor updated successfully!', 'success');
            closeEditSponsorModal();
            loadAllSponsors();
        } else {
            showAlert(result.message || 'Error updating sponsor', 'error');
        }
    } catch (error) {
        showAlert('Error updating sponsor', 'error');
    }
});

function toggleEditOtherCategory(select) {
    const otherGroup = document.getElementById('editOtherCategoryGroup');
    if (select.value === 'others') {
        otherGroup.style.display = 'block';
    } else {
        otherGroup.style.display = 'none';
        document.getElementById('editOtherCategory').value = '';
    }
}

async function addSponsor() {
    const form = document.getElementById('addSponsorForm');
    const formData = new FormData(form);
    const sponsorData = {
        company_name: formData.get('company_name'),
        cto_phone: formData.get('cto_phone'),
        ceo_phone: formData.get('ceo_phone'),
        ceo_mail: formData.get('ceo_mail'),
        previous_sponsor: formData.get('previous_sponsor'),
        website: formData.get('website'),
        sponsor_mail: formData.get('sponsor_mail'),
        ruetian_name: formData.get('ruetian_name'),
        ruetian_phone: formData.get('ruetian_phone'),
        ruetian_mail: formData.get('ruetian_mail'),
        ruetian_linkedin: formData.get('ruetian_linkedin'),
        category: formData.get('category'),
        other_category: formData.get('other_category')
    };
    try {
        const response = await fetch('/api/sponsors/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(sponsorData)
        });
        const result = await response.json();
        if (result.success) {
            showAlert('Sponsor added successfully!', 'success');
            form.reset();
            document.getElementById('otherCategoryGroup').style.display = 'none';
            loadSponsorCount();
        } else {
            showAlert(result.message || 'Error adding sponsor', 'error');
        }
    } catch (error) {
        console.error('Error adding sponsor:', error);
        showAlert('Error adding sponsor', 'error');
    }
}

async function deleteSponsor(sponsorId) {
    if (!isAdmin) return;
    if (!confirm('Are you sure you want to delete this sponsor?')) {
        return;
    }
    try {
        const response = await fetch(`/api/sponsors/delete/${sponsorId}`, {
            method: 'DELETE'
        });
        const result = await response.json();
        if (result.success) {
            showAlert('Sponsor deleted successfully!', 'success');
            loadSponsorCount();
            if (currentSponsors.length > 0) {
                loadAllSponsors();
            }
        } else {
            showAlert(result.message || 'Error deleting sponsor', 'error');
        }
    } catch (error) {
        console.error('Error deleting sponsor:', error);
        showAlert('Error deleting sponsor', 'error');
    }
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').innerHTML = '';
}

function showAlert(message, type) {
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.position = 'fixed';
        toastContainer.style.top = '24px';
        toastContainer.style.right = '24px';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    const toast = document.createElement('div');
    toast.className = `toast-message toast-${type}`;
    toast.innerHTML = `
        <span>${message}</span>
        <button class="close-toast">&times;</button>
    `;
    toast.style.background = type === 'success' ? '#28a745' : (type === 'warning' ? '#ffc107' : '#dc3545');
    toast.style.color = '#fff';
    toast.style.padding = '14px 22px';
    toast.style.marginBottom = '12px';
    toast.style.borderRadius = '8px';
    toast.style.boxShadow = '0 2px 12px rgba(0,0,0,0.12)';
    toast.style.display = 'flex';
    toast.style.alignItems = 'center';
    toast.style.justifyContent = 'space-between';
    toast.style.fontSize = '1.08em';
    toastContainer.appendChild(toast);
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3500);
    toast.querySelector('.close-toast').addEventListener('click', () => {
        toast.remove();
    });
}

function downloadAllSponsors() {
    if (!isAdmin) return;
    window.location.href = '/api/sponsors/download';
}
 </script>
{% endblock %}
